+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|QUERY PLAN                                                                                                                                                                                                                                                              |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|Limit  (cost=4099802.35..4099815.61 rows=100 width=480)                                                                                                                                                                                                                 |
|  CTE store_total                                                                                                                                                                                                                                                       |
|    ->  Finalize GroupAggregate  (cost=1271500.26..2424161.63 rows=7884824 width=255)                                                                                                                                                                                   |
|          Group Key: customer.c_customer_id, customer.c_first_name, customer.c_last_name, customer.c_preferred_cust_flag, customer.c_birth_country, customer.c_login, customer.c_email_address, date_dim.d_year                                                         |
|          ->  Gather Merge  (cost=1271500.26..2161334.18 rows=6570686 width=223)                                                                                                                                                                                        |
|                Workers Planned: 2                                                                                                                                                                                                                                      |
|                ->  Partial GroupAggregate  (cost=1270500.24..1401913.96 rows=3285343 width=223)                                                                                                                                                                        |
|                      Group Key: customer.c_customer_id, customer.c_first_name, customer.c_last_name, customer.c_preferred_cust_flag, customer.c_birth_country, customer.c_login, customer.c_email_address, date_dim.d_year                                             |
|                      ->  Sort  (cost=1270500.24..1278713.59 rows=3285343 width=201)                                                                                                                                                                                    |
|                            Sort Key: customer.c_customer_id, customer.c_first_name, customer.c_last_name, customer.c_preferred_cust_flag, customer.c_birth_country, customer.c_login, customer.c_email_address, date_dim.d_year                                        |
|                            ->  Parallel Hash Join  (cost=11587.32..263607.07 rows=3285343 width=201)                                                                                                                                                                   |
|                                  Hash Cond: (store_sales.ss_customer_sk = customer.c_customer_sk)                                                                                                                                                                      |
|                                  ->  Parallel Hash Join  (cost=2390.82..203054.07 rows=3436312 width=18)                                                                                                                                                               |
|                                        Hash Cond: (store_sales.ss_sold_date_sk = date_dim.d_date_sk)                                                                                                                                                                   |
|                                        ->  Parallel Seq Scan on store_sales  (cost=0.00..191213.40 rows=3599740 width=18)                                                                                                                                              |
|                                        ->  Parallel Hash  (cost=1853.70..1853.70 rows=42970 width=8)                                                                                                                                                                   |
|                                              ->  Parallel Seq Scan on date_dim  (cost=0.00..1853.70 rows=42970 width=8)                                                                                                                                                |
|                                  ->  Parallel Hash  (cost=6151.33..6151.33 rows=78333 width=191)                                                                                                                                                                       |
|                                        ->  Parallel Seq Scan on customer  (cost=0.00..6151.33 rows=78333 width=191)                                                                                                                                                    |
|  CTE web_total                                                                                                                                                                                                                                                         |
|    ->  Finalize GroupAggregate  (cost=362651.02..678303.05 rows=2159229 width=255)                                                                                                                                                                                     |
|          Group Key: customer_1.c_customer_id, customer_1.c_first_name, customer_1.c_last_name, customer_1.c_preferred_cust_flag, customer_1.c_birth_country, customer_1.c_login, customer_1.c_email_address, date_dim_1.d_year                                         |
|          ->  Gather Merge  (cost=362651.02..606328.74 rows=1799358 width=223)                                                                                                                                                                                          |
|                Workers Planned: 2                                                                                                                                                                                                                                      |
|                ->  Partial GroupAggregate  (cost=361650.99..397638.15 rows=899679 width=223)                                                                                                                                                                           |
|                      Group Key: customer_1.c_customer_id, customer_1.c_first_name, customer_1.c_last_name, customer_1.c_preferred_cust_flag, customer_1.c_birth_country, customer_1.c_login, customer_1.c_email_address, date_dim_1.d_year                             |
|                      ->  Sort  (cost=361650.99..363900.19 rows=899679 width=204)                                                                                                                                                                                       |
|                            Sort Key: customer_1.c_customer_id, customer_1.c_first_name, customer_1.c_last_name, customer_1.c_preferred_cust_flag, customer_1.c_birth_country, customer_1.c_login, customer_1.c_email_address, date_dim_1.d_year                        |
|                            ->  Parallel Hash Join  (cost=11587.32..94317.01 rows=899679 width=204)                                                                                                                                                                     |
|                                  Hash Cond: (web_sales.ws_bill_customer_sk = customer_1.c_customer_sk)                                                                                                                                                                 |
|                                  ->  Parallel Hash Join  (cost=2390.82..70146.33 rows=899859 width=21)                                                                                                                                                                 |
|                                        Hash Cond: (web_sales.ws_sold_date_sk = date_dim_1.d_date_sk)                                                                                                                                                                   |
|                                        ->  Parallel Seq Scan on web_sales  (cost=0.00..65392.69 rows=900069 width=21)                                                                                                                                                  |
|                                        ->  Parallel Hash  (cost=1853.70..1853.70 rows=42970 width=8)                                                                                                                                                                   |
|                                              ->  Parallel Seq Scan on date_dim date_dim_1  (cost=0.00..1853.70 rows=42970 width=8)                                                                                                                                     |
|                                  ->  Parallel Hash  (cost=6151.33..6151.33 rows=78333 width=191)                                                                                                                                                                       |
|                                        ->  Parallel Seq Scan on customer customer_1  (cost=0.00..6151.33 rows=78333 width=191)                                                                                                                                         |
|  ->  Incremental Sort  (cost=997337.67..112249303.33 rows=838730804 width=480)                                                                                                                                                                                         |
|        Sort Key: store_total_1.customer_id, store_total_1.customer_first_name, store_total_1.customer_last_name, store_total_1.customer_email_address                                                                                                                  |
|        Presorted Key: store_total_1.customer_id                                                                                                                                                                                                                        |
|        ->  Merge Join  (cost=490966.69..69709476.05 rows=838730804 width=480)                                                                                                                                                                                          |
|              Merge Cond: (store_total.customer_id = store_total_1.customer_id)                                                                                                                                                                                         |
|              Join Filter: (CASE WHEN (web_total.year_total > '0'::numeric) THEN (web_total_1.year_total / web_total.year_total) ELSE 0.0 END > CASE WHEN (store_total.year_total > '0'::numeric) THEN (store_total_1.year_total / store_total.year_total) ELSE 0.0 END)|
|              ->  Merge Join  (cost=247325.45..258019.69 rows=709351 width=200)                                                                                                                                                                                         |
|                    Merge Cond: (web_total_1.customer_id = store_total.customer_id)                                                                                                                                                                                     |
|                    ->  Sort  (cost=49305.89..49332.88 rows=10796 width=100)                                                                                                                                                                                            |
|                          Sort Key: web_total_1.customer_id                                                                                                                                                                                                             |
|                          ->  CTE Scan on web_total web_total_1  (cost=0.00..48582.65 rows=10796 width=100)                                                                                                                                                             |
|                                Filter: (dyear = 2002)                                                                                                                                                                                                                  |
|                    ->  Sort  (cost=198019.56..198052.41 rows=13141 width=100)                                                                                                                                                                                          |
|                          Sort Key: store_total.customer_id                                                                                                                                                                                                             |
|                          ->  CTE Scan on store_total  (cost=0.00..197120.60 rows=13141 width=100)                                                                                                                                                                      |
|                                Filter: ((year_total > '0'::numeric) AND (dyear = 2001))                                                                                                                                                                                |
|              ->  Materialize  (cost=243641.24..256172.90 rows=709435 width=612)                                                                                                                                                                                        |
|                    ->  Merge Join  (cost=243641.24..254399.32 rows=709435 width=612)                                                                                                                                                                                   |
|                          Merge Cond: (web_total.customer_id = store_total_1.customer_id)                                                                                                                                                                               |
|                          ->  Sort  (cost=54193.31..54202.30 rows=3599 width=100)                                                                                                                                                                                       |
|                                Sort Key: web_total.customer_id                                                                                                                                                                                                         |
|                                ->  CTE Scan on web_total  (cost=0.00..53980.73 rows=3599 width=100)                                                                                                                                                                    |
|                                      Filter: ((year_total > '0'::numeric) AND (dyear = 2001))                                                                                                                                                                          |
|                          ->  Materialize  (cost=189447.93..189645.05 rows=39424 width=512)                                                                                                                                                                             |
|                                ->  Sort  (cost=189447.93..189546.49 rows=39424 width=512)                                                                                                                                                                              |
|                                      Sort Key: store_total_1.customer_id                                                                                                                                                                                               |
|                                      ->  CTE Scan on store_total store_total_1  (cost=0.00..177408.54 rows=39424 width=512)                                                                                                                                            |
|                                            Filter: (dyear = 2002)                                                                                                                                                                                                      |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
